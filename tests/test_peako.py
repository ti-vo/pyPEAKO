import pypeako
import numpy as np
import xarray as xr

sample_spectrum = np.array([-9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            7.46939031e-06, 2.17718352e-05, 1.22778602e-05, 3.37680940e-05,
                            9.21584651e-05, 7.79119800e-05, 9.26251378e-05, 1.59051298e-04,
                            2.10319777e-04, 2.67937779e-04, 2.23250565e-04, 1.17516749e-04,
                            1.05867795e-04, 9.57395678e-05, 6.15788958e-05, 5.16203181e-05,
                            4.98198024e-05, 3.50949595e-05, 2.60236066e-05, 3.52648240e-05,
                            3.19032042e-05, 3.88562221e-05, 1.03256047e-04, 4.05233644e-04,
                            1.47290481e-03, 3.81307839e-03, 6.52180612e-03, 9.10375267e-03,
                            1.17009180e-02, 1.54821193e-02, 1.84055064e-02, 1.61721781e-02,
                            1.02825044e-02, 4.98376368e-03, 2.22811103e-03, 1.35171262e-03,
                            2.15501431e-03, 6.18332298e-03, 4.88978717e-03, 5.42603375e-04,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02,
                            -9.99000000e+02, -9.99000000e+02, -9.99000000e+02, -9.99000000e+02])


training_result = np.array([[0.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            0.00000000e+00,  0.00000000e+00, -3.38245019e+04],
                           [0.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            0.00000000e+00, 1.00000000e+00,  6.83836337e+04],
                           [0.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 0.00000000e+00, -1.26888725e+05],
                           [0.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 1.00000000e+00, -1.10581487e+05],
                           [0.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            1.00000000e+00, 0.00000000e+00, -1.42985118e+05],
                           [0.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            1.00000000e+00,  1.00000000e+00, -1.42985118e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            0.00000000e+00,  0.00000000e+00, -6.79519607e+03],
                           [0.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            0.00000000e+00, 1.00000000e+00,  5.37610164e+04],
                           [0.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            5.00000000e-01, 0.00000000e+00, -1.12268442e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            5.00000000e-01, 1.00000000e+00, -1.00600331e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            1.00000000e+00, 0.00000000e+00, -1.42985118e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            1.00000000e+00,  1.00000000e+00, -1.42985118e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            0.00000000e+00,  0.00000000e+00, -6.79519607e+03],
                           [0.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            0.00000000e+00, 1.00000000e+00,  5.37610164e+04],
                           [0.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            5.00000000e-01, 0.00000000e+00, -1.12268442e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            5.00000000e-01, 1.00000000e+00, -1.00600331e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            1.00000000e+00, 0.00000000e+00, -1.42985118e+05],
                           [0.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            1.00000000e+00,  1.00000000e+00, -1.42985118e+05],
                           [0.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            0.00000000e+00,  0.00000000e+00, -5.04835913e+04],
                           [0.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            0.00000000e+00, 1.00000000e+00, -2.26488025e+04],
                           [0.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 0.00000000e+00, -8.74561150e+04],
                           [0.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 1.00000000e+00, -6.93213296e+04],
                           [0.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            1.00000000e+00, 0.00000000e+00, -1.30754678e+05],
                           [0.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            1.00000000e+00,  1.00000000e+00, -1.23655398e+05],
                           [0.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            0.00000000e+00,  0.00000000e+00, -6.10973605e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            0.00000000e+00, 1.00000000e+00, -4.92183826e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            5.00000000e-01, 0.00000000e+00, -8.21141135e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            5.00000000e-01, 1.00000000e+00, -6.72126650e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            1.00000000e+00, 0.00000000e+00, -1.06082930e+05],
                           [0.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            1.00000000e+00,  1.00000000e+00, -9.80698949e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            0.00000000e+00,  0.00000000e+00, -6.10973605e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            0.00000000e+00, 1.00000000e+00, -4.92183826e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            5.00000000e-01, 0.00000000e+00, -8.21141135e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            5.00000000e-01, 1.00000000e+00, -6.72126650e+04],
                           [0.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            1.00000000e+00, 0.00000000e+00, -1.06082930e+05],
                           [0.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            1.00000000e+00,  1.00000000e+00, -9.80698949e+04],
                           [1.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            0.00000000e+00,  0.00000000e+00, -1.54022231e+04],
                           [1.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            0.00000000e+00, 1.00000000e+00,  6.08736195e+04],
                           [1.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 0.00000000e+00, -9.94756460e+04],
                           [1.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 1.00000000e+00, -6.82669666e+04],
                           [1.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            1.00000000e+00, 0.00000000e+00, -1.32652501e+05],
                           [1.00000000e+00, 0.00000000e+00,  5.00000000e-03,
                            1.00000000e+00,  1.00000000e+00, -1.19016266e+05],
                           [1.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            0.00000000e+00,  0.00000000e+00, -6.07060145e+04],
                           [1.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            0.00000000e+00, 1.00000000e+00,  9.34546347e+03],
                           [1.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            5.00000000e-01, 0.00000000e+00, -1.11635844e+05],
                           [1.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            5.00000000e-01, 1.00000000e+00, -9.82807481e+04],
                           [1.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            1.00000000e+00, 0.00000000e+00, -1.39470621e+05],
                           [1.00000000e+00, 0.00000000e+00, 1.00000000e-02,
                            1.00000000e+00,  1.00000000e+00, -1.36518433e+05],
                           [1.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            0.00000000e+00,  0.00000000e+00, -6.07060145e+04],
                           [1.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            0.00000000e+00, 1.00000000e+00,  9.34546347e+03],
                           [1.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            5.00000000e-01, 0.00000000e+00, -1.11635844e+05],
                           [1.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            5.00000000e-01, 1.00000000e+00, -9.82807481e+04],
                           [1.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            1.00000000e+00, 0.00000000e+00, -1.39470621e+05],
                           [1.00000000e+00, 0.00000000e+00, 1.50000000e-02,
                            1.00000000e+00,  1.00000000e+00, -1.36518433e+05],
                           [1.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            0.00000000e+00,  0.00000000e+00, -5.21002467e+04],
                           [1.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            0.00000000e+00, 1.00000000e+00, -5.51930268e+04],
                           [1.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 0.00000000e+00, -6.32764034e+04],
                           [1.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                            5.00000000e-01, 1.00000000e+00, -6.10974019e+04],
                           [1.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                           1.00000000e+00, 0.00000000e+00, -9.75075490e+04],
                           [1.00000000e+00, 1.00000000e+00,  5.00000000e-03,
                           1.00000000e+00,  1.00000000e+00, -9.89836410e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            0.00000000e+00,  0.00000000e+00, -8.87213054e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            0.00000000e+00, 1.00000000e+00, -8.82995708e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            5.00000000e-01, 0.00000000e+00, -7.59285802e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                            5.00000000e-01, 1.00000000e+00, -7.37495952e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                           1.00000000e+00, 0.00000000e+00, -9.89836416e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.00000000e-02,
                           1.00000000e+00,  1.00000000e+00, -1.01514081e+05],
                           [1.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            0.00000000e+00,  0.00000000e+00, -8.87213054e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            0.00000000e+00, 1.00000000e+00, -8.82995708e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            5.00000000e-01, 0.00000000e+00, -7.59285802e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                            5.00000000e-01, 1.00000000e+00, -7.37495952e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                           1.00000000e+00, 0.00000000e+00, -9.89836416e+04],
                           [1.00000000e+00, 1.00000000e+00,  1.50000000e-02,
                           1.00000000e+00,  1.00000000e+00, -1.01514081e+05]])

vel_vector = np.repeat(999999., len(sample_spectrum))
vel_vector[64:192] = np.linspace(-4.5, 4.5, 128)

spec_data = [xr.Dataset({'velocity_vectors': xr.DataArray(vel_vector[np.newaxis, :], dims=['chirp', 'spectrum'],
                                                          coords={'chirp': [0], 'spectrum': np.arange(256)})})]


def test_lin2z():
    assert(pypeako.lin2z(0.001) == -30.0)


def test_argnearest():
    assert(pypeako.argnearest([0, 1, 2, 3, 50, 44, 43, 88], 11.2) == 3)


def test_find_edges():
    assert(pypeako.find_edges(sample_spectrum, -999, [122]) == ([92], [131]))


def test_mask_velocity_vectors():
    pypeako.utils.mask_velocity_vectors(spec_data)


def test_find_index_in_sublist():
    i, left_edge = pypeako.utils.find_index_in_sublist(4, [tuple(([1, 2, 3], [0, 0, 0])), tuple(([4, 5, 6], [1, 1, 1]))])
    assert(i == 1)
    assert(left_edge == 3)


def test_training_stats():
    P = pypeako.Peako()
    P.training_result['loop'] = training_result
    P.marked_peaks_index = [1, 2, 3, 4]


def test_average_single_bin():
    specdata_values = np.array([[1, np.nan, 1, 1, 1],[np.nan, 1, 1, 1, 1], [1, 1, np.nan, 1, 1], [1, 1, 1, np.nan,1],
                                [1, 1, 1, 1, np.nan]])
    B = np.array([[0.25, 0.25], [0.25, 0.25]])
